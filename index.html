<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Dashboard - Infirmier</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    /* --- CSS --- */
    :root {
      --primary: #5d74f2;
      --primary-light: #ebeffe;
      --success: #31c971;
      --success-light: #e0fbea;
      --warning: #ffb648;
      --warning-light: #fff8ec;
      --danger: #ff5a5a;
      --danger-light: #ffeded;
      --gray-100: #f9fafb;
      --gray-200: #f1f3f9;
      --gray-300: #e5e7eb;
      --gray-400: #d1d5db;
      --gray-500: #9ca3af;
      --gray-600: #6b7280;
      --gray-700: #4b5563;
      --gray-800: #374151;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.04);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.05);
      --border-radius: 8px;
      --transition-speed: 0.2s;
      font-size: 15px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Inter',sans-serif;
      background: var(--gray-100);
      color: var(--gray-800);
      min-height:100vh;
      visibility:hidden;
    }
    body.loaded { visibility:visible; animation:fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .container { max-width:1200px; margin:0 auto; padding:0 12px; }
    .header {
      display:flex; align-items:center; padding:15px 0;
      margin-bottom:20px; gap:10px; border-bottom:1px solid var(--gray-200);
    }
    .header-main-content { display:flex; align-items:center; gap:10px; flex-grow:1; }
    .logo-img { height:35px; }
    .header-title { color:var(--primary); font-size:1.3rem; font-weight:600; }
    .logout-btn { padding:5px 10px; font-size:0.8rem; border-radius:var(--border-radius); }
    .card {
      background:white; border-radius:var(--border-radius);
      box-shadow:var(--shadow-md); margin-bottom:20px;
      overflow:hidden;
    }
    .card-header {
      display:flex; justify-content:space-between;
      align-items:center; padding:14px 16px;
      border-bottom:1px solid var(--gray-200);
    }
    .card-title { font-size:1rem; font-weight:600; display:flex; align-items:center; }
    .card-title i { margin-right:10px; color:var(--primary); }
    .card-actions { color:white; background:var(--primary);
      border-radius:var(--border-radius); width:32px; height:32px;
      display:flex; align-items:center; justify-content:center;
    }
    .card-body { padding:16px; }
    .patient-info {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
      gap:12px;
    }
    .info-group { margin-bottom:5px; }
    .info-label { font-size:0.75rem; color:var(--gray-500); margin-bottom:4px; }
    .info-value { font-size:0.85rem; font-weight:500; word-break:break-word; }
    .empty-state { text-align:center; padding:1.5rem; color:var(--gray-500); }
    .empty-state i { font-size:2rem; margin-bottom:0.5rem; opacity:0.6; display:block; }
    .empty-state-message { font-size:1rem; font-weight:500; margin-bottom:0.25rem; }
    .empty-state-description { font-size:0.85rem; }

    .btn-group { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    .btn {
      padding:8px 14px; font-size:0.85rem; font-weight:500;
      border:none; border-radius:var(--border-radius);
      display:inline-flex; align-items:center; cursor:pointer;
      transition:all var(--transition-speed) ease;
    }
    .btn i { margin-right:6px; }
    .btn-primary { background:var(--primary); color:white; }
    .btn-primary:hover { background:#4a62d8; }
    .btn-outline {
      background:white; color:var(--primary);
      border:1px solid var(--gray-300);
    }
    .btn-outline:hover { background:var(--primary-light); border-color:var(--primary); }
    .btn-success { background:var(--success); color:white; }
    .btn-success:hover { background:#28a960; }
    .btn:disabled { background:var(--gray-300); cursor:not-allowed; opacity:0.7; }

    .status {
      display:inline-flex; align-items:center;
      padding:4px 8px; border-radius:4px;
      font-size:0.75rem; background:var(--gray-200);
      color:var(--gray-600); margin-left:10px;
    }

    textarea, input[type="number"] {
      width:100%; padding:10px 12px; font-size:0.9rem;
      border:1px solid var(--gray-300); border-radius:var(--border-radius);
      transition:all var(--transition-speed) ease;
      font-family:'Inter',sans-serif;
    }
    textarea { resize:vertical; min-height:100px; }
    textarea:focus, input:focus {
      outline:none; border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(93,116,242,0.1);
    }

    .message {
      padding:10px; border-radius:6px; margin-top:12px;
      font-size:0.85rem; font-weight:500; display:none;
      word-break:break-word;
    }
    .message-success { background:var(--success-light); color:var(--success); }
    .message-error   { background:var(--danger-light);  color:var(--danger); }
    .message-info    { background:var(--primary-light); color:var(--primary); border-left:4px solid var(--primary); }
    .no-print { @media print { display:none !important; } }

    @media(max-width:480px) {
      .header { justify-content:center; }
      .header-main-content { width:100%; justify-content:center; margin-bottom:10px; }
      .logout-btn { width:100%; }
      .btn { padding:8px 12px; font-size:0.8rem; }
      .patient-info { grid-template-columns:1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <div class="header-main-content">
        <div class="logo">
          <img src="clinique-nakhil-logo-horizontal.webp" alt="Logo" class="logo-img">
        </div>
        <h1 class="header-title">ü©∫ Infirmier</h1>
      </div>
      <button id="logoutBtn" class="btn btn-outline logout-btn no-print">
        <i class="fas fa-sign-out-alt"></i> D√©connexion
      </button>
    </div>

    <!-- QR SCANNER CARD -->
    <div class="card no-print">
      <div class="card-header">
        <h2 class="card-title"><i class="fas fa-qrcode"></i> Scanner Patient</h2>
        <div class="card-actions"><i class="fas fa-camera"></i></div>
      </div>
      <div class="card-body">
        <button id="scanQrButton" class="btn btn-primary">
          <i class="fas fa-qrcode"></i> Scanner QR
        </button>
        <div id="scanner-container" style="display:none; margin-top:12px;">
          <video id="scanner-video" playsinline style="width:100%;border:1px solid var(--gray-300);border-radius:var(--border-radius);"></video>
        </div>
        <div id="obsMessage" class="message message-info"></div>
      </div>
    </div>

    <!-- PATIENT INFO -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title"><i class="fas fa-user-circle"></i> Infos Patient</h2>
        <div class="card-actions"><i class="fas fa-user"></i></div>
      </div>
      <div class="card-body">
        <div id="patientInfo" class="patient-info">
          <div class="empty-state" style="grid-column:1/-1;">
            <i class="fas fa-qrcode"></i>
            <div class="empty-state-message">Pr√™t √† scanner</div>
            <div class="empty-state-description">Cliquez sur ‚ÄúScanner QR‚Äù.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- OBSERVATION -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title"><i class="fas fa-notes-medical"></i> Observation</h2>
        <div class="card-actions"><i class="fas fa-clipboard-list"></i></div>
      </div>
      <div class="card-body" id="observationCardBody" style="opacity:0.5;pointer-events:none;">
        <textarea id="observationInput" placeholder="Saisir ou dicter..." disabled></textarea>
        <div class="btn-group">
          <button id="startObservationBtn" class="btn btn-outline" disabled>
            <i class="fas fa-microphone"></i> D√©marrer
          </button>
          <button id="stopObservationBtn" class="btn btn-outline" disabled>
            <i class="fas fa-stop-circle"></i> Arr√™ter
          </button>
          <span id="observationStatus" class="status"></span>
        </div>
        <div class="btn-group">
          <button id="submitObservationBtn" class="btn btn-success" disabled>
            <i class="fas fa-check-circle"></i> Enregistrer
          </button>
        </div>
        <div id="obsMessage" class="message"></div>
      </div>
    </div>

    <!-- VITAL SIGNS -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title"><i class="fas fa-heartbeat"></i> Signes Vitaux</h2>
        <div class="card-actions"><i class="fas fa-stethoscope"></i></div>
      </div>
      <div class="card-body">
        <form id="vitalSignsForm">
          <div class="input-group">
            <label>Temp√©rature (¬∞C)</label>
            <input id="vs_temperature" type="number" step="0.1" required>
          </div>
          <div class="input-group">
            <label>Tension systolique</label>
            <input id="vs_tension_systolic" type="number" required>
          </div>
          <div class="input-group">
            <label>Tension diastolique</label>
            <input id="vs_tension_diastolic" type="number" required>
          </div>
          <div class="input-group">
            <label>SpO‚ÇÇ (%)</label>
            <input id="vs_spo2" type="number" required>
          </div>
          <div class="input-group">
            <label>Fr√©quence cardiaque</label>
            <input id="vs_heart_rate" type="number" required>
          </div>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-plus-circle"></i> Enregistrer
          </button>
        </form>
        <div id="vitalSignMessage" class="message"></div>
      </div>
    </div>
  </div>

  <!-- Dependencies -->
  <script src="./jsQR.js"></script>
  <script>
    // --- Globals & Config ---
    const BASE_URL = 'https://workflows.aphelionxinnovations.com';
    const LOGIN_PAGE_URL = 'https://hicham-taoufik.github.io/login/';
    const QR_TARGET_BASE_URL = 'app://medilink/patient';
    let currentIPP = null;

    // --- Helpers ---
    function fetchWithAuth(url, opts={}) {
      const token = localStorage.getItem('authToken');
      if (!token) { alert('Session expir√©e'); location.href = LOGIN_PAGE_URL; return; }
      opts.headers = { ...(opts.headers||{}), 'Authorization': `Bearer ${token}` };
      if (opts.body && !(opts.body instanceof FormData)) opts.headers['Content-Type']='application/json';
      return fetch(url, opts).then(res=>{
        if (res.status===401) { localStorage.removeItem('authToken'); location.href=LOGIN_PAGE_URL; }
        if (!res.ok) return res.text().then(t=>Promise.reject(t));
        return res.json();
      });
    }
    function logout() { localStorage.removeItem('authToken'); location.href=LOGIN_PAGE_URL; }
    function showMessage(id,msg,type='info'){
      const el=document.getElementById(id);
      if(!el)return;
      el.innerHTML= msg ? `<i class="fas fa-${type==='error'?'times-circle':type==='success'?'check-circle':'info-circle'} me-2"></i>${msg}` : '';
      el.className = `message message-${type}`;
      el.style.display = msg?'block':'none';
    }

    // --- Observation Recording ---
    let mediaRecorder, audioChunks=[];
    function startRecording(){
      if(!currentIPP) return alert("Charger un patient");
      navigator.mediaDevices.getUserMedia({audio:true})
        .then(stream=>{
          mediaRecorder=new MediaRecorder(stream);
          audioChunks=[];
          mediaRecorder.ondataavailable=e=>{ if(e.data.size) audioChunks.push(e.data); };
          mediaRecorder.onstop=()=>{
            const blob=new Blob(audioChunks,{type:'audio/webm'});
            document.getElementById('observationStatus').innerText='Transcription‚Ä¶';
            // TODO: send blob to transcription endpoint
          };
          mediaRecorder.start();
          document.getElementById('observationStatus').innerText='Enregistrement‚Ä¶';
          toggleObsButtons(true);
        })
        .catch(e=>alert("Micro non accessible: "+e.message));
    }
    function stopRecording(){
      if(mediaRecorder && mediaRecorder.state==='recording') mediaRecorder.stop();
      toggleObsButtons(false);
    }
    function toggleObsButtons(rec){
      document.getElementById('startObservationBtn').disabled=rec;
      document.getElementById('stopObservationBtn').disabled=!rec;
    }

    // --- QR Scanner & Patient Load ---
    let scanning=false, currentStream, scanTimeout;
    const video = document.getElementById('scanner-video');
    document.getElementById('scanQrButton').addEventListener('click',async()=>{
      if(!scanning){
        document.getElementById('obsMessage').style.display='none';
        document.getElementById('scanner-container').style.display='block';
        try{
          currentStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
          video.srcObject=currentStream;
          await video.play();
          scanning=true;
          scanTimeout = setTimeout(stopScanner,30000);
          requestAnimationFrame(tick);
        }catch(e){
          alert("Cam√©ra non accessible: "+e.message);
          stopScanner();
        }
      } else {
        stopScanner();
      }
    });
    function stopScanner(){
      scanning=false;
      clearTimeout(scanTimeout);
      if(currentStream) currentStream.getTracks().forEach(t=>t.stop());
      document.getElementById('scanner-container').style.display='none';
    }
    function tick(){
      if(!scanning) return;
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        const c=document.createElement('canvas');
        c.width=video.videoWidth; c.height=video.videoHeight;
        c.getContext('2d').drawImage(video,0,0);
        const img = c.getContext('2d').getImageData(0,0,c.width,c.height);
        const code = jsQR(img.data,img.width,img.height,{inversionAttempts:'dontInvert'});
        if(code){
          stopScanner();
          processScannedQrCode(code.data);
          return;
        }
      }
      requestAnimationFrame(tick);
    }
    function processScannedQrCode(url){
      try{
        const u=new URL(url);
        if(!url.startsWith(QR_TARGET_BASE_URL)) throw "Non reconnu";
        const ipp=u.searchParams.get('ipp');
        if(!ipp) throw "IPP manquant";
        loadPatient(ipp);
      }catch(e){
        showMessage('obsMessage','QR invalide: '+e,'error');
      }
    }
    function loadPatient(ipp){
      currentIPP=ipp;
      const pi=document.getElementById('patientInfo');
      pi.innerHTML='<div style="grid-column:1/-1;text-align:center;"><i class="fas fa-spinner fa-spin"></i> Chargement‚Ä¶</div>';
      enableObservationSection(false);
      fetchWithAuth(`${BASE_URL}/webhook/nurse-get-patient?ipp=${ipp}`)
        .then(data=>{
          pi.innerHTML=`
            <div class="info-group"><div class="info-label">Nom</div><div class="info-value">${data.prenom} ${data.nom}</div></div>
            <div class="info-group"><div class="info-label">IPP</div><div class="info-value">${data.ipp}</div></div>
            <div class="info-group"><div class="info-label">CIN</div><div class="info-value">${data.cin}</div></div>
            <div class="info-group"><div class="info-label">Tel</div><div class="info-value">${data.telephone}</div></div>
            <div class="info-group"><div class="info-label">Adresse</div><div class="info-value">${data.adresse}</div></div>
            <div class="info-group"><div class="info-label">Mutuelle</div><div class="info-value">${data.mutuelle||'Aucune'}</div></div>
          `;
          enableObservationSection(true);
        })
        .catch(err=>{
          pi.innerHTML=`<div class="message message-error" style="display:block;grid-column:1/-1;">Erreur: ${err}</div>`;
        });
    }
    function enableObservationSection(on){
      const obsCard=document.getElementById('observationCardBody');
      obsCard.style.opacity=on?'1':'0.5';
      obsCard.style.pointerEvents=on?'auto':'none';
      ['observationInput','startObservationBtn','stopObservationBtn','submitObservationBtn']
        .forEach(id=>document.getElementById(id).disabled=!on);
    }

    // --- Observation Submit ---
    document.getElementById('submitObservationBtn').addEventListener('click',()=>{
      const obs=document.getElementById('observationInput').value.trim();
      if(!currentIPP||!obs) return alert('Vide ou patient non charg√©');
      fetchWithAuth(`${BASE_URL}/webhook/nurse-submit-observation`,{
        method:'POST',
        body:JSON.stringify({ipp:currentIPP,observation:obs})
      })
      .then(()=>alert('Observation enregistr√©e'))
      .catch(e=>alert('Erreur: '+e));
    });

    // --- Vital Signs Submit ---
    document.getElementById('vitalSignsForm').addEventListener('submit',e=>{
      e.preventDefault();
      if(!currentIPP) return alert('Patient non charg√©');
      const payload = {
        patient_ipp: currentIPP,
        temperature: parseFloat(document.getElementById('vs_temperature').value),
        tension_systolic: parseInt(document.getElementById('vs_tension_systolic').value),
        tension_diastolic: parseInt(document.getElementById('vs_tension_diastolic').value),
        spo2: parseInt(document.getElementById('vs_spo2').value),
        heart_rate: parseInt(document.getElementById('vs_heart_rate').value),
      };
      fetchWithAuth(`${BASE_URL}/webhook/vital-signs`,{
        method:'POST',
        body:JSON.stringify(payload)
      })
      .then(()=>alert('Signes vitaux enregistr√©s'))
      .catch(e=>alert('Erreur: '+e));
    });

    // --- Logout & Init ---
    document.getElementById('logoutBtn').addEventListener('click',logout);
    window.addEventListener('DOMContentLoaded',()=>{
      if(!localStorage.getItem('authToken')) return logout();
      document.body.classList.add('loaded');
    });
  </script>
</body>
</html>
